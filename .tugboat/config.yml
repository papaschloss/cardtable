services:
  # What to call the service hosting the site. Because there is only
  # one service, it is automatically set as the default service, which
  # does a few things
  #   1. Clones the git repository into the service container
  #   2. Exposes port 80 to the Tugboat HTTP proxy
  #   3. Routes requests to the preview URL to this service
  apache:
    # Use the available version of Apache by not specifying a version
    image: tugboatqa/httpd

    # A set of commands to run while building this service
    commands:
      # Commands that set up the basic preview infrastructure
      init:
        # Check for updates to apt-get, and then use it to install nodejs / npm / yarn
        - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
        - echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
        - curl -sL https://deb.nodesource.com/setup_16.x | bash -
        - apt-get update
        - apt-get install nodejs yarn unzip

        - node --version
        - yarn --version
        - yarn config set network-timeout 600000 -g

        # Clean up apt artifacts to keep the Preview small
        - apt-get clean
        - rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

      build:
        # install deps
        - yarn install

        # move card images
        - unzip -qq .imagepacks/mc/core.zip
        - unzip -qq .imagepacks/mc/Captain_America_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Ronan_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Black_Widow_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Hulk_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Ms_Marvel_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Thor_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Ant_Man_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Doctor_Strange_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Green_Goblin_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Wrecking_Crew_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Red_Skull_Image_Pack.zip
        - unzip -qq .imagepacks/mc/Baron_Zemo_Firestarter_Image_Pack.zip

        - mv 055c536f-adba-4bc2-acbf-9aefb9756046/Sets/dea583bf-554b-43c8-a6ed-a44782094ad1/Cards/* public/images/cards

        # remove the 'homepage' field
        - sed -i '3d' ./package.json

        # build
        - NODE_OPTIONS=--max_old_space_size=8192 yarn build:tugboat

        # clean up build artifacts
        - rm -rf node_modules
        - rm -rf 055c536f-adba-4bc2-acbf-9aefb9756046
        - rm -rf public

        # Link the document root to the expected path. This example links the
        # /public directory generated by the Jekyll build to the docroot
        - ln -snf "${TUGBOAT_ROOT}"/build "${DOCROOT}"
